<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>---</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="---"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-09-18T15:57+0800"/>
<meta name="author" content=""/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">---</h1>


---
layout: post
title: Baking Pi - Operating Systems Development Lesson 1
tags: [os]
---


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 课时1 OK01</a>
<ul>
<li><a href="#sec-1-1">1.1 起步</a></li>
<li><a href="#sec-1-2">1.2 开始</a></li>
<li><a href="#sec-1-3">1.3 第一行代码</a></li>
<li><a href="#sec-1-4">1.4 成功输出</a></li>
<li><a href="#sec-1-5">1.5 让机器动起来</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 课时1 OK01</h2>
<div class="outline-text-2" id="text-1">


<p>
本课时主要在于说明最基本的起步和怎样打开Raspberry Pi上的'OK' LED灯,灯的
位置在RCA和USB接口附近.
</p>

</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> 起步</h3>
<div class="outline-text-3" id="text-1-1">


<p>
我假设你已经访问了 <a href="http://www.cl.cam.ac.uk/freshers/raspberrypi/tutorials/os/downloads.html">下载</a><sup><a class="footref" name="fnr-.1" href="#fn-.1">1</a></sup> 页面获得了其中的GNU的工具链.同时在该页面上,也
存在一个叫做 OS Template<sup><a class="footref" name="fnr-.2" href="#fn-.2">2</a></sup>的文件.请把它下载下来,解压到新建的文件夹内.
</p>

</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> 开始</h3>
<div class="outline-text-3" id="text-1-2">

<p>目前为止,你应该已经完成解压模板文件了.请在其'source'文件夹中创建一个名称
为'main.s'的文件.改文件会包含带开发的操作系统的代码.用文本编辑器打开,准
备向其中写入汇编代码.Raspberry Pi使用的是ARMv6的汇编代码,因此,我们也需要
根据ARMv6的语法和要求来写代码.
</p>
<p>
拷贝如下代码:
</p>


<pre class="example">.section .init
.globl _start
_start:
</pre>

<p>
当然,目前什么都不会发生,这些代码都是等待给汇编器的指令.汇编器是翻译汇编
代码到二进制代码的程序.汇编代码中,每行就是一个新的指令.其中第一行告诉汇
编器<sup><a class="footref" name="fnr-.3" href="#fn-.3">3</a></sup>放置我们代码的位置.OS模板文件会让 <b>.init</b> 的模块首先输出.这里比较
重要,因为我们需要控制具体哪段代码首先执行.不这么做的话,代码根据字典顺序
来执行. <b>.senction</b> 指令就是告诉汇编器把代码放哪里,代码范围是从该点开始
一直到下个 <b>.section</b> 或者文件尾.
</p>
<p>
后面两行只是为了防止警告信息,没有重要意义.
</p>
</div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> 第一行代码</h3>
<div class="outline-text-3" id="text-1-3">

<p>现在我们开始真正的编写代码.代码的作用是告诉处理器将 0x20200000存入寄存器
r0.显然会涉及两个问题,寄存器是什么和为什么是0x20200000这个数字.
</p>
<p>
寄存器是处理器内部的一小片存储单元,用于存储处理器目前工作中需要使用的数
字.他们的数量很少,且基本都有特定的作用,具体作用稍后再说.共有13个通用寄存
器,分别编号为(r0&hellip;r12),其不具有特定作用,可以随意使用.例子中,我们按照顺
序,就使用了第一个寄存器,不过随便用其中的任何一个也没有关系.当然,随后的代
码中使用寄存器就需要保持一致.
</p>
<p>
0x20200000是个16进制形式的数字.具体16进制数字,可以见下面的介绍:
等待处理<sup><a class="footref" name="fnr-.4" href="#fn-.4">4</a></sup>
</p>
<p>
所以第一个指令就是将数字20200000<sub>16</sub> 载入r0寄存器.看起来没什么作用,其实不
然.在计算机中,有很多设备和内存块.为了能够访问他们,我们就给其中每个都赋予
一个地址.如同邮编或者网址,为的是能够让我们识别设备或者内存块的位置.计算
机中的地址都是数字编码,所以20200000<sub>16成为GPIO控制器的地址</sub>.这其实是硬件
制造商设计的地址,制造商可以随意指定地址,只要地址没有冲突就可以.具体的地
址信息可以从硬件的手册中获得, <del>这些地址没有被别的系统指定,而且一般都是很 大的约整数</del> <sup><a class="footref" name="fnr-.5" href="#fn-.5">5</a></sup>
</p>
</div>

</div>

<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> 成功输出</h3>
<div class="outline-text-3" id="text-1-4">

<p>读过手册后,我就知道我们需要发送两个消息给GPIO控制器.我们必须让控制器能够
理解我们的消息,一旦这样,控制器就会按照我们所愿打开OK LED灯.由于这是个十
分简单的芯片,所以我们只用很简单的发送几个数字就可以了.
</p>



<pre class="example">mov r1,#1
lsl r1,#18f
str r1,[r0,#4]
</pre>

<p>
以上的代码就能够输出到GPIO的第16个针脚上.首先我们向r1寄存器写入一个数字,
然后发给GPIO控制器.前两个命令是为了往r1里写个数字,其实我们也可以用之前用
过的那个 <b>ldr</b> 的命令,不过现在这么做是为了方便以后指定任意针脚.直接写值
不如通过表达式来指定值来的灵活. OK LED是连接到GPIO的第16个针脚处.所以我
们需要发送命令激活第16个针脚.
</p>
<p>
r1中的数字用来激活LED的针脚.第一行将1<sub>10</sub> 放入r1. <b>mov</b> 指令比 <b>ldr</b> 指令
快,因为它不涉及内存操作.不过 <b>mov</b> 只能用来载入确定值<sup><a class="footref" name="fnr-.6" href="#fn-.6">6</a></sup>.在ARM的汇编
代码中,基本所有指令都由三个字母打头.这种方式被称作助记符,表明该命令实际
执行的操作.比如 <b>mov</b> 是 move的简写, <b>ldr</b> 是 load register的简写. <b>mov</b>
指令将第二个参数 <b>#1</b> 移入到第一个参数的 <b>r1</b>.一般来说, <b>#</b> 必须用来指定
数字,不过我们已经看到过反例了<sup><a class="footref" name="fnr-.7" href="#fn-.7">7</a></sup>.
</p>
<p>
第二条指令是 <b>lsl</b> 其实是逻辑左移运算. 表示将第一个参数的二进制值向左移
动第二个参数代表的位数. 在我们这,就是将1<sub>10</sub>(二进制表示1<sub>2</sub>)左移18位(这样
就变成了1000000000000000000<sub>2</sub> = 262144<sub>10</sub>)
</p>
<p>
不熟悉二进制的,展开以下内容:
</p>
<p>
!!!!二进制说明的占位符.
</p>
<p>
这些命令中固定的数字也是我从硬件说明手册上找到的.手册上说了,GPIO控制器有
一24b的空间,用于决定GIIO的设定.前四个设定前十个GPIO pin, 第五到八设定第
十一到二十个GPIO pin,以此类推.总共54个针脚,所以需要6*4个byte,总共24个.在
每四个byte中,有三个bits用来指定某一个GPIO pin.如果我们需要第16个pin,那么就要
设定第五到八byte.因为我们在处理10-19范围类的pin.我们处理的是3bits中的第6
个.所以需要移位18.
</p>
<p>
最后, <b>str</b> (store register的简写)命令将第一个参数 <b>r1</b> 存储到第二个参数
运算结果指定的内存地址中.第二个参数可以直接是寄存器, 在这里是 <b>r0</b>,我们
之前用来指定了GPIO控制器的地址,然后加上一个数值,在这里是 <b>#4</b>.所以结果就
是我们在GPIO控制器的地址基础上加上4,在这里写入 <b>r1</b> 的值.其实就是第二个
4bytes,前面说了6*4bytes的原理.到此为止我们发送了第一个消息给GPIO控制器,
告诉它让第十六个pin做好输出准备.
</p>
</div>

</div>

<div id="outline-container-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> 让机器动起来</h3>
<div class="outline-text-3" id="text-1-5">


<p>
现在,LED已经准备好被打开,但是我们还需要打开它.也即发送一个消息让GPIO控制
器将pin 16 关上.  <i>没错,是关上</i>
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn-.1" href="#fnr-.1">1</a></sup> 译注:目前指向依然是课程的下载地址,未镜像该位置.
</p>


<p class="footnote"><sup><a class="footnum" name="fn-.2" href="#fnr-.2">2</a></sup> 译注:以后叫做OS模板
</p>


<p class="footnote"><sup><a class="footnum" name="fn-.3" href="#fnr-.3">3</a></sup> 
</p>

<p class="footnote"><sup><a class="footnum" name="fn-.4" href="#fnr-.4">4</a></sup> 译注:TODO等待处理
</p>


<p class="footnote"><sup><a class="footnum" name="fn-.5" href="#fnr-.5">5</a></sup> 译注:TODO没有理解
</p>


<p class="footnote"><sup><a class="footnum" name="fn-.6" href="#fnr-.6">6</a></sup> 译注,这里的脚注未理解.
</p>


<p class="footnote"><sup><a class="footnum" name="fn-.7" href="#fnr-.7">7</a></sup> 译注:反例在哪里?
</p>



</div>
</div>
</div>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2012-09-18T15:57+0800</p>
<p class="author">Author: </p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.9.1 with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
